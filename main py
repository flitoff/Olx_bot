import requests
from bs4 import BeautifulSoup
import telegram
import time
import threading
from telegram.ext import Updater, CommandHandler

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
SEARCH_QUERY = "fpv –¥—Ä–æ–Ω"
OLX_URL = f"https://www.olx.ua/d/uk/q-{SEARCH_QUERY.replace(' ', '-')}/"
BOT_TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–ë–û–¢–ê"
CHAT_ID = "–í–ê–®_CHAT_ID"

bot = telegram.Bot(token=BOT_TOKEN)
found_ads = set()

def get_new_ads():
    """–ü–∞—Ä—Å–∏–º OLX –∏ –∏—â–µ–º –Ω–æ–≤—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è"""
    headers = {"User-Agent": "Mozilla/5.0"}
    response = requests.get(OLX_URL, headers=headers)

    if response.status_code != 200:
        print("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã OLX")
        return []

    soup = BeautifulSoup(response.text, "html.parser")
    ads = soup.find_all("div", class_="css-rc5s2u")  # –ö–ª–∞—Å—Å –æ–±—ä—è–≤–ª–µ–Ω–∏–π (–º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è!)

    new_ads = []
    for ad in ads:
        title_tag = ad.find("h6")
        link_tag = ad.find("a")
        price_tag = ad.find("p", class_="css-10b0gli")

        if title_tag and link_tag:
            title = title_tag.text.strip()
            link = "https://www.olx.ua" + link_tag["href"]
            price = price_tag.text.strip() if price_tag else "–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"

            if link not in found_ads:
                found_ads.add(link)
                new_ads.append((title, price, link))

    return new_ads

def send_telegram_message(ads):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ Telegram"""
    for title, price, link in ads:
        message = f"üõ∏ –ù–æ–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ!\n\nüìå {title}\nüí∞ {price}\nüîó {link}"
        bot.send_message(chat_id=CHAT_ID, text=message)

def monitor_olx():
    """–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ OLX"""
    while True:
        new_ads = get_new_ads()
        if new_ads:
            send_telegram_message(new_ads)
            print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(new_ads)} –Ω–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π")
        else:
            print("üöÄ –ü–æ–∫–∞ –Ω–æ–≤—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π –Ω–µ—Ç...")

        time.sleep(600)  # –ü—Ä–æ–≤–µ—Ä—è—Ç—å –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç

# === Telegram-–±–æ—Ç ===
def start(update, context):
    update.message.reply_text("ü§ñ –ü—Ä–∏–≤–µ—Ç! –Ø –º–æ–Ω–∏—Ç–æ—Ä—é FPV-–¥—Ä–æ–Ω—ã –Ω–∞ OLX.")
    threading.Thread(target=monitor_olx, daemon=True).start()

def status(update, context):
    update.message.reply_text("üöÄ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç OLX.")

def stop(update, context):
    update.message.reply_text("‚õî –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–Ω–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ñ–æ–Ω–µ).")

def main():
    updater = Updater(BOT_TOKEN, use_context=True)
    dp = updater.dispatcher

    dp.add_handler(CommandHandler("start", start))
    dp.add_handler(CommandHandler("status", status))
    dp.add_handler(CommandHandler("stop", stop))

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    updater.start_polling()
    updater.idle()

if __name__ == "__main__":
    main()
